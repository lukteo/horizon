version: '3.8'

services:
  postgres:
    image: postgres:15
    container_name: horizon-postgres
    environment:
      POSTGRES_USER: horizon_user
      POSTGRES_PASSWORD: horizon_pass
      POSTGRES_DB: horizon
      PGDATA: /var/lib/postgresql/data/pgdata
    ports:
      - "6432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "horizon_user"]
      interval: 5s
      timeout: 5s
      retries: 5

  valkey:
    image: valkey/valkey:7.2
    container_name: horizon-valkey
    command: valkey-server --requirepass horizon_valkey_pass --save 60 1
    ports:
      - "6379:6379"
    volumes:
      - valkeydata:/data
    restart: unless-stopped

  nats:
    image: nats:latest
    container_name: horizon-nats
    ports:
      - "4222:4222"
      - "8222:8222"
    command: >
      -c /etc/nats/nats.conf
      --jetstream
    volumes:
      - ./nats-config:/etc/nats
      - natsdata:/data
    restart: unless-stopped

  quickwit:
    image: quickwit/quickwit:latest
    container_name: horizon-quickwit
    environment:
      QW_CLUSTER_ID: qw-cluster-horizon
      QW_NODE_ID: qw-node-1
    ports:
      - "7280:7280"
    volumes:
      - qwdata:/quickwit-data
    command: run
    restart: unless-stopped

  clickhouse:
    image: clickhouse/clickhouse-server:latest
    container_name: horizon-clickhouse
    ports:
      - "8123:8123"  # HTTP interface
      - "9000:9000"  # Native interface
      - "9009:9009"  # Replication
    environment:
      CLICKHOUSE_DB: horizon_analytics
      CLICKHOUSE_USER: horizon_clickhouse_user
      CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: 1
    volumes:
      - chdata:/var/lib/clickhouse
    restart: unless-stopped

  minio:
    image: minio/minio:latest
    container_name: horizon-minio
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      MINIO_ROOT_USER: minio_access_key
      MINIO_ROOT_PASSWORD: minio_secret_key
    command: server /data --console-address ":9001"
    volumes:
      - miniodata:/data
    restart: unless-stopped

  horizon-server:
    build:
      context: ./server
      dockerfile: Dockerfile
    container_name: horizon-server
    ports:
      - "8000:8000"
    depends_on:
      - postgres
      - valkey
      - nats
      - quickwit
      - clickhouse
      - minio
    environment:
      - PORT=8000
      - DATABASE_URL=postgresql://horizon_user:horizon_pass@postgres:5432/horizon
      - REDIS_URL=redis://:horizon_valkey_pass@valkey:6379
      - NATS_URL=nats://horizon_ingest:ingest_pass@nats:4222
      - QUICKWIT_URL=http://quickwit:7280
      - CLICKHOUSE_URL=http://clickhouse:8123
      - CLIENT_ORIGIN=http://localhost:3000
      - JWT_SECRET=change-this-in-production
      - BLOB_STORAGE_ENDPOINT=minio:9000
      - BLOB_STORAGE_ACCESS_KEY=minio_access_key
      - BLOB_STORAGE_SECRET_KEY=minio_secret_key
      - BLOB_STORAGE_BUCKET=horizon-logs
      - BLOB_STORAGE_SECURE=false
    restart: unless-stopped

  horizon-client:
    build:
      context: .
      dockerfile: client/Dockerfile
    container_name: horizon-client
    ports:
      - "3000:3000"
    depends_on:
      - horizon-ingestion
    environment:
      - REACT_APP_API_URL=http://localhost:8000
    restart: unless-stopped

volumes:
  pgdata:
  valkeydata:
  natsdata:
  qwdata:
  chdata:
  miniodata: